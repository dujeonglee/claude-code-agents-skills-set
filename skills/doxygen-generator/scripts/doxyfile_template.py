#!/usr/bin/env python3
"""Doxyfile template generation with sensible defaults."""

from typing import Optional

# Language-specific default file patterns
LANGUAGE_PATTERNS = {
    "c":      "*.c *.h",
    "c++":    "*.c *.h *.cpp *.hpp *.cc *.hh *.cxx *.hxx",
    "java":   "*.java",
    "python": "*.py",
    "auto":   "*.c *.h *.cpp *.hpp *.cc *.hh *.cxx *.hxx *.java *.py",
}


def generate_doxyfile(
    project_name: str,
    input_dirs: list[str],
    output_dir: str,
    dot_path: Optional[str] = None,
    file_patterns: Optional[str] = None,
    exclude_dirs: Optional[list[str]] = None,
    language: str = "c",
    recursive: bool = True,
    generate_html: bool = True,
    generate_xml: bool = True,
    generate_graphs: bool = True,
) -> str:
    """Generate a complete Doxyfile configuration string.

    Args:
        project_name: Name shown in generated docs.
        input_dirs: List of directories to scan for source files.
        output_dir: Root output directory for generated docs.
        dot_path: Directory containing the dot binary. None disables graphs.
        file_patterns: Space-separated file patterns. None uses language default.
        exclude_dirs: Directories to exclude from scanning.
        language: One of 'c', 'c++', 'java', 'python', 'auto'.
        recursive: Whether to scan input directories recursively.
        generate_html: Whether to generate HTML output.
        generate_xml: Whether to generate XML output (needed for query.py).
        generate_graphs: Whether to generate call/caller graphs.

    Returns:
        Complete Doxyfile content as a string.
    """
    lang_key = language.lower()
    if file_patterns is None:
        file_patterns = LANGUAGE_PATTERNS.get(lang_key, LANGUAGE_PATTERNS["auto"])

    if exclude_dirs is None:
        exclude_dirs = []

    # Always exclude common non-source directories
    default_excludes = [".git", ".svn", "node_modules", "__pycache__", ".doxygen",
                        "build", "cmake-build-*", ".venv", "venv"]
    all_excludes = list(set(exclude_dirs + default_excludes))

    have_dot = dot_path is not None and generate_graphs
    optimize_c = lang_key in ("c",)

    input_str = " \\\n                         ".join(f'"{d}"' for d in input_dirs)
    exclude_str = " \\\n                         ".join(f'"{d}"' for d in all_excludes)

    lines = [
        f'# Doxyfile generated by doxygen-generator skill',
        f'',
        f'# --- Project ---',
        f'PROJECT_NAME           = "{project_name}"',
        f'OUTPUT_DIRECTORY       = "{output_dir}"',
        f'',
        f'# --- Input ---',
        f'INPUT                  = {input_str}',
        f'FILE_PATTERNS          = {file_patterns}',
        f'RECURSIVE              = {"YES" if recursive else "NO"}',
        f'EXCLUDE                = {exclude_str}',
        f'EXCLUDE_PATTERNS       = */.git/* */node_modules/*',
        f'',
        f'# --- Extraction ---',
        f'EXTRACT_ALL            = YES',
        f'EXTRACT_PRIVATE        = YES',
        f'EXTRACT_STATIC         = YES',
        f'EXTRACT_LOCAL_CLASSES   = YES',
        f'EXTRACT_LOCAL_METHODS   = YES',
        f'',
        f'# --- Source browsing ---',
        f'SOURCE_BROWSER         = YES',
        f'INLINE_SOURCES         = YES',
        f'REFERENCED_BY_RELATION = YES',
        f'REFERENCES_RELATION    = YES',
        f'',
        f'# --- Output formats ---',
        f'GENERATE_HTML          = {"YES" if generate_html else "NO"}',
        f'GENERATE_XML           = {"YES" if generate_xml else "NO"}',
        f'GENERATE_LATEX         = NO',
        f'GENERATE_MAN           = NO',
        f'GENERATE_RTF           = NO',
        f'XML_PROGRAMLISTING     = YES',
        f'',
        f'# --- Graphs ---',
        f'HAVE_DOT               = {"YES" if have_dot else "NO"}',
    ]

    if have_dot:
        lines += [
            f'DOT_PATH               = "{dot_path}"',
            f'CALL_GRAPH             = YES',
            f'CALLER_GRAPH           = YES',
            f'DOT_IMAGE_FORMAT       = svg',
            f'INTERACTIVE_SVG        = YES',
            f'DOT_GRAPH_MAX_NODES    = 100',
            f'MAX_DOT_GRAPH_DEPTH    = 0',
        ]
    else:
        lines += [
            f'CALL_GRAPH             = NO',
            f'CALLER_GRAPH           = NO',
        ]

    lines += [
        f'',
        f'# --- Language ---',
        f'OPTIMIZE_OUTPUT_FOR_C  = {"YES" if optimize_c else "NO"}',
        f'',
        f'# --- Misc ---',
        f'QUIET                  = YES',
        f'WARNINGS               = YES',
        f'WARN_IF_UNDOCUMENTED   = NO',
        f'WARN_IF_DOC_ERROR      = YES',
        f'WARN_NO_PARAMDOC       = NO',
        f'GENERATE_TREEVIEW      = YES',
        f'DISABLE_INDEX          = NO',
        f'FULL_SIDEBAR           = NO',
        f'',
    ]

    return "\n".join(lines)
